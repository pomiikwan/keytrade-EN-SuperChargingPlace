<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thousand-Station Liquid-Cooled Ultra-Fast Charging Project - Enhanced Interactive Scenario Forecast</title>
    <link rel="stylesheet" href="库里蓝暗夜主题.css">
    <style>
        /* Enhanced Interactive Calculator Specific Styles */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .feature-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(0, 119, 192, 0.3);
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #B8C5D6;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            border-radius: 10px 10px 0 0;
        }

        .tab.active {
            color: #FFC72C;
            border-bottom-color: #FFC72C;
            background: rgba(255, 199, 44, 0.1);
        }

        .tab:hover {
            color: #FFFFFF;
            background: rgba(29, 66, 138, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .parameters-panel {
            background: rgba(26, 35, 71, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(0, 119, 192, 0.3);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .visualization-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .chart-container {
            background: rgba(26, 35, 71, 0.7);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 119, 192, 0.3);
            position: relative;
            overflow: hidden;
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #1D428A, #0077C0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .risk-assessment {
            background: rgba(26, 35, 71, 0.9);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(0, 119, 192, 0.3);
            margin-bottom: 30px;
        }

        .risk-factors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .risk-factor {
            background: rgba(29, 66, 138, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(0, 119, 192, 0.2);
            transition: all 0.3s ease;
        }

        .risk-factor:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 119, 192, 0.3);
            border-color: rgba(255, 199, 44, 0.4);
        }

        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .risk-name {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .risk-level {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .risk-low {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .risk-medium {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .risk-high {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .risk-slider {
            width: 100%;
            margin: 15px 0;
        }

        .risk-description {
            color: #B8C5D6;
            font-size: 14px;
            line-height: 1.5;
        }

        .scenario-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .scenario-btn {
            padding: 12px 20px;
            border: 2px solid rgba(0, 119, 192, 0.3);
            border-radius: 25px;
            background: rgba(26, 35, 71, 0.7);
            color: #B8C5D6;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .scenario-btn:hover {
            border-color: #FFC72C;
            color: #FFFFFF;
            background: rgba(29, 66, 138, 0.9);
            transform: translateY(-2px);
        }

        .scenario-btn.active {
            background: linear-gradient(135deg, #1D428A, #0077C0);
            border-color: #FFC72C;
            color: #FFFFFF;
            box-shadow: 0 4px 15px rgba(255, 199, 44, 0.3);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: rgba(26, 35, 71, 0.7);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 119, 192, 0.3);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #1D428A, #0077C0, #FFC72C);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .result-card:hover::before {
            transform: scaleX(1);
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 119, 192, 0.3);
            border-color: rgba(255, 199, 44, 0.4);
        }

        .result-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #FFC72C, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 14px;
            color: #B8C5D6;
            font-weight: 500;
        }

        .result-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .trend-up {
            color: #4CAF50;
        }

        .trend-down {
            color: #F44336;
        }

        .param-group {
            margin-bottom: 25px;
        }

        .param-group-title {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1D428A, #0077C0);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 119, 192, 0.3);
        }

        .calculate-btn:hover {
            background: linear-gradient(135deg, #0077C0, #1D428A);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 119, 192, 0.4);
        }

        .export-btn {
            padding: 10px 20px;
            background: rgba(255, 199, 44, 0.1);
            border: 1px solid rgba(255, 199, 44, 0.3);
            color: #FFC72C;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .export-btn:hover {
            background: rgba(255, 199, 44, 0.2);
            border-color: #FFC72C;
            color: #FFFFFF;
        }

        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: #4CAF50;
            margin-left: 15px;
        }

        .real-time-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .sensitivity-chart {
            height: 300px;
            position: relative;
            background: rgba(10, 14, 39, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        @media (max-width: 1200px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }

            .parameters-panel {
                position: static;
            }

            .visualization-panel {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }

            .feature-tabs {
                gap: 10px;
            }

            .tab {
                padding: 12px 18px;
                font-size: 14px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .risk-factors {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header Section -->
        <div class="header-section fade-in">
            <div class="header">
                <h1 class="title">Enhanced Interactive Scenario Forecast</h1>
                <p class="subtitle">Real-time Data Visualization · Investment Scenario Simulation · Risk Assessment Analysis</p>
                <div class="real-time-indicator">
                    <div class="real-time-dot"></div>
                    <span>Calculating in Real-time</span>
                </div>
            </div>
        </div>

        <!-- Feature Tabs -->
        <div class="feature-tabs">
            <button class="tab active" onclick="switchTab('calculator')">
                🧮 Financial Calculator
            </button>
            <button class="tab" onclick="switchTab('scenarios')">
                📊 Investment Scenarios
            </button>
            <button class="tab" onclick="switchTab('risk')">
                ⚠️ Risk Assessment
            </button>
            <button class="tab" onclick="switchTab('visualization')">
                📈 Data Visualization
            </button>
        </div>

        <!-- Financial Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <div class="calculator-grid">
                <!-- Parameters Panel -->
                <div class="parameters-panel">
                    <div class="param-group">
                        <div class="param-group-title">
                            <span>🏗️</span>
                            <span>Infrastructure Parameters</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Total Investment (100M RMB)</label>
                                <input type="number" id="totalInvestment" value="28" min="1" max="100" step="1">
                            </div>
                            <div class="form-group">
                                <label>Number of Stations</label>
                                <input type="number" id="stationCount" value="1000" min="100" max="5000" step="100">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Single Station Power (kW)</label>
                                <input type="number" id="stationPower" value="7200" min="1000" max="10000" step="100">
                            </div>
                            <div class="form-group">
                                <label>Construction Period (Years)</label>
                                <input type="number" id="constructionPeriod" value="4" min="1" max="10" step="1">
                            </div>
                        </div>
                    </div>

                    <div class="param-group">
                        <div class="param-group-title">
                            <span>💰</span>
                            <span>Financial Parameters</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Annual Charging Utilization Rate (%)</label>
                                <input type="number" id="utilizationRate" value="25" min="5" max="50" step="1">
                            </div>
                            <div class="form-group">
                                <label>Charging Service Fee (RMB/kWh)</label>
                                <input type="number" id="serviceFee" value="0.8" min="0.1" max="2" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Operation & Maintenance Cost Rate (%)</label>
                                <input type="number" id="maintenanceCost" value="15" min="5" max="30" step="1">
                            </div>
                            <div class="form-group">
                                <label>Discount Rate (%)</label>
                                <input type="number" id="discountRate" value="12" min="5" max="20" step="1">
                            </div>
                        </div>
                    </div>

                    <button class="calculate-btn" onclick="calculateResults()">
                        Start Calculation
                    </button>
                </div>

                <!-- Visualization Panel -->
                <div class="visualization-panel">
                    <div class="chart-container">
                        <div class="chart-title">
                            <div class="chart-icon">📈</div>
                            <span>Cash Flow Forecast</span>
                        </div>
                        <div id="cashflowChart" class="chart-placeholder">
                            <!-- Cash flow chart will be rendered here -->
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">
                            <div class="chart-icon">🎯</div>
                            <span>IRR Sensitivity Analysis</span>
                        </div>
                        <div id="irrChart" class="chart-placeholder">
                            <!-- IRR sensitivity chart will be rendered here -->
                        </div>
                    </div>

                    <div class="chart-container full-width">
                        <div class="chart-title">
                            <div class="chart-icon">💹</div>
                            <span>Investment Return Analysis</span>
                            <button class="export-btn" onclick="exportChart()">Export Chart</button>
                        </div>
                        <div id="roiChart" class="chart-placeholder">
                            <!-- ROI analysis chart will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculation Results -->
            <div class="results-grid" id="resultsGrid">
                <div class="result-card">
                    <div class="result-value" id="irrValue">42.8%</div>
                    <div class="result-label">Internal Rate of Return (IRR)</div>
                    <div class="result-trend trend-up">↑ Better than Industry Average</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="npvValue">1.24 Billion</div>
                    <div class="result-label">Net Present Value (NPV@12%)</div>
                    <div class="result-trend trend-up">↑ High Investment Value</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="paybackValue">4.5 Years</div>
                    <div class="result-label">Investment Payback Period</div>
                    <div class="result-trend trend-up">↑ Fast Payback Speed</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="profitValue">12.1 Billion</div>
                    <div class="result-label">10-Year Cumulative Profit</div>
                    <div class="result-trend trend-up">↑ Strong Profitability</div>
                </div>
            </div>
        </div>

        <!-- Investment Scenarios Tab -->
        <div id="scenarios" class="tab-content">
            <div class="scenario-buttons">
                <button class="scenario-btn" onclick="loadScenario('conservative')">Pessimistic Scenario</button>
                <button class="scenario-btn active" onclick="loadScenario('baseline')">Baseline Scenario</button>
                <button class="scenario-btn" onclick="loadScenario('optimistic')">Optimistic Scenario</button>
                <button class="scenario-btn" onclick="loadScenario('custom')">Custom Scenario</button>
            </div>

            <div class="visualization-panel">
                <div class="chart-container full-width">
                    <div class="chart-title">
                        <div class="chart-icon">📊</div>
                        <span>Multi-Scenario Comparative Analysis</span>
                    </div>
                    <div id="scenarioChart" class="chart-placeholder">
                        <!-- Scenario comparison chart -->
                    </div>
                </div>
            </div>

            <div class="results-grid" id="scenarioResults">
                <!-- Scenario analysis results -->
            </div>
        </div>

        <!-- Risk Assessment Tab -->
        <div id="risk" class="tab-content">
            <div class="risk-assessment">
                <div class="chart-title">
                    <div class="chart-icon">⚠️</div>
                    <span>Risk Assessment Matrix</span>
                    <button class="export-btn" onclick="exportRiskReport()">Export Risk Report</button>
                </div>

                <div class="risk-factors">
                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">🏗️ Technical Risk</div>
                            <div class="risk-level risk-medium">Medium</div>
                        </div>
                        <input type="range" class="risk-slider" id="techRisk" min="0" max="100" value="35">
                        <div class="risk-description">
                            Liquid-cooled ultra-fast charging technology maturity, equipment reliability, technology iteration risk
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">📈 Market Risk</div>
                            <div class="risk-level risk-low">Low</div>
                        </div>
                        <input type="range" class="risk-slider" id="marketRisk" min="0" max="100" value="25">
                        <div class="risk-description">
                            Market competition intensity, demand growth expectations, price fluctuation risk
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">🏛️ Policy Risk</div>
                            <div class="risk-level risk-medium">Medium</div>
                        </div>
                        <input type="range" class="risk-slider" id="policyRisk" min="0" max="100" value="40">
                        <div class="risk-description">
                            Subsidy policy changes, industry standard updates, regulatory requirement adjustments
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">💰 Financial Risk</div>
                            <div class="risk-level risk-low">Low</div>
                        </div>
                        <input type="range" class="risk-slider" id="financialRisk" min="0" max="100" value="20">
                        <div class="risk-description">
                            Financing cost changes, cash flow stability, exchange rate fluctuation risk
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">⚡ Operational Risk</div>
                            <div class="risk-level risk-medium">Medium</div>
                        </div>
                        <input type="range" class="risk-slider" id="operationalRisk" min="0" max="100" value="30">
                        <div class="risk-description">
                            Operation and maintenance management complexity, personnel skill requirements, equipment maintenance costs
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">🌍 Environmental Risk</div>
                            <div class="risk-level risk-low">Low</div>
                        </div>
                        <input type="range" class="risk-slider" id="environmentalRisk" min="0" max="100" value="15">
                        <div class="risk-description">
                            Environmental protection requirement changes, energy policy adjustments, sustainable development pressure
                        </div>
                    </div>
                </div>

                <div class="sensitivity-chart">
                    <h4 style="color: #FFFFFF; margin-bottom: 15px;">Sensitivity Analysis - Spider Chart</h4>
                    <svg id="riskSpiderChart" class="chart-svg">
                        <!-- Spider chart will be rendered here -->
                    </svg>
                </div>
            </div>
        </div>

        <!-- Data Visualization Tab -->
        <div id="visualization" class="tab-content">
            <div class="visualization-panel">
                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon">🌍</div>
                        <span>Market Trend Analysis</span>
                    </div>
                    <div id="marketTrendChart" class="chart-placeholder">
                        <!-- Market trend chart -->
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon">🚗</div>
                        <span>Electric Vehicle Growth Forecast</span>
                    </div>
                    <div id="evGrowthChart" class="chart-placeholder">
                        <!-- Electric vehicle growth chart -->
                    </div>
                </div>

                <div class="chart-container full-width">
                    <div class="chart-title">
                        <div class="chart-icon">💡</div>
                        <span>Technology Evolution Roadmap</span>
                    </div>
                    <div id="techRoadmapChart" class="chart-placeholder">
                        <!-- Technology roadmap -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentScenario = 'baseline';
        let calculationResults = {};

        // Tab Switching
        function switchTab(tabName) {
            // Remove all active states
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Activate selected tab
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Initialize corresponding functionality based on tab
            switch(tabName) {
                case 'calculator':
                    initCalculator();
                    break;
                case 'scenarios':
                    initScenarios();
                    break;
                case 'risk':
                    initRiskAssessment();
                    break;
                case 'visualization':
                    initVisualization();
                    break;
            }
        }

        // Financial Calculation Function
        function calculateResults() {
            const params = {
                totalInvestment: parseFloat(document.getElementById('totalInvestment').value),
                stationCount: parseInt(document.getElementById('stationCount').value),
                stationPower: parseInt(document.getElementById('stationPower').value),
                constructionPeriod: parseInt(document.getElementById('constructionPeriod').value),
                utilizationRate: parseFloat(document.getElementById('utilizationRate').value),
                serviceFee: parseFloat(document.getElementById('serviceFee').value),
                maintenanceCost: parseFloat(document.getElementById('maintenanceCost').value),
                discountRate: parseFloat(document.getElementById('discountRate').value)
            };

            // Calculate core financial indicators
            const annualRevenue = params.stationCount * params.stationPower * params.utilizationRate / 100 * 365 * params.serviceFee / 1000;
            const annualCost = annualRevenue * params.maintenanceCost / 100;
            const annualProfit = annualRevenue - annualCost;

            // 10-year cash flow analysis
            let cashFlows = [];
            let cumulativeCashFlow = -params.totalInvestment * 10000; // 转换为万元

            for (let year = 1; year <= 10; year++) {
                if (year <= params.constructionPeriod) {
                    // Construction period, gradual investment
                    const investment = -params.totalInvestment * 10000 / params.constructionPeriod;
                    cumulativeCashFlow += investment;
                    cashFlows.push({
                        year: year,
                        investment: investment,
                        revenue: 0,
                        profit: investment,
                        cumulative: cumulativeCashFlow
                    });
                } else {
                    // Operation period
                    cumulativeCashFlow += annualProfit;
                    cashFlows.push({
                        year: year,
                        investment: 0,
                        revenue: annualRevenue,
                        profit: annualProfit,
                        cumulative: cumulativeCashFlow
                    });
                }
            }

            // Calculate IRR
            const irr = calculateIRR(cashFlows.map(cf => cf.profit), params.totalInvestment * 10000);

            // Calculate NPV
            const npv = calculateNPV(cashFlows.map(cf => cf.profit), params.discountRate / 100);

            // Calculate investment payback period
            let paybackPeriod = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                if (cashFlows[i].cumulative > 0) {
                    paybackPeriod = i;
                    break;
                }
            }

            // 10-year total profit
            const totalProfit = cashFlows.reduce((sum, cf) => sum + Math.max(0, cf.profit), 0);

            // Update result display
            document.getElementById('irrValue').textContent = irr.toFixed(1) + '%';
            document.getElementById('npvValue').textContent = (npv / 100000).toFixed(1) + ' Billion';
            document.getElementById('paybackValue').textContent = paybackPeriod + ' Years';
            document.getElementById('profitValue').textContent = (totalProfit / 100000).toFixed(1) + ' Billion';

            // Save results
            calculationResults = {
                irr: irr,
                npv: npv,
                paybackPeriod: paybackPeriod,
                totalProfit: totalProfit,
                cashFlows: cashFlows,
                params: params
            };

            // Update charts
            updateCharts();
        }

        // IRR Calculation Function
        function calculateIRR(cashFlows, initialInvestment) {
            let irr = 0.1; // Initial guess value
            let npv;
            const maxIterations = 100;
            const tolerance = 0.0001;

            for (let i = 0; i < maxIterations; i++) {
                npv = -initialInvestment;
                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + irr, j + 1);
                }

                if (Math.abs(npv) < tolerance) {
                    break;
                }

                // Newton-Raphson method
                let derivative = 0;
                for (let j = 0; j < cashFlows.length; j++) {
                    derivative -= (j + 1) * cashFlows[j] / Math.pow(1 + irr, j + 2);
                }

                irr = irr - npv / derivative;

                if (irr < -0.99) irr = -0.99; // Prevent denominator from being zero
            }

            return irr * 100; // Convert to percentage
        }

        // NPV Calculation Function
        function calculateNPV(cashFlows, discountRate) {
            let npv = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                npv += cashFlows[i] / Math.pow(1 + discountRate, i + 1);
            }
            return npv;
        }

        // Update Charts
        function updateCharts() {
            drawCashflowChart();
            drawIRRChart();
            drawROIChart();
        }

        // Draw Cash Flow Chart
        function drawCashflowChart() {
            const container = document.getElementById('cashflowChart');
            if (!calculationResults.cashFlows) return;

            const data = calculationResults.cashFlows;
            const width = container.offsetWidth;
            const height = 250;
            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // 创建SVG
            const svg = `
                <svg width="${width}" height="${height}">
                    <g transform="translate(${margin.left},${margin.top})">
                        <!-- Coordinate axes -->
                        <line x1="0" y1="${chartHeight}" x2="${chartWidth}" y2="${chartHeight}" stroke="#B8C5D6" stroke-width="2"/>
                        <line x1="0" y1="0" x2="0" y2="${chartHeight}" stroke="#B8C5D6" stroke-width="2"/>

                        <!-- Cash flow bar chart -->
                        ${data.map((d, i) => {
                            const barWidth = chartWidth / data.length * 0.6;
                            const x = i * (chartWidth / data.length) + (chartWidth / data.length - barWidth) / 2;
                            const height = Math.abs(d.cumulative) / Math.max(...data.map(d => Math.abs(d.cumulative))) * chartHeight * 0.8;
                            const y = d.cumulative >= 0 ? chartHeight - height : chartHeight;

                            return `
                                <rect x="${x}" y="${y}" width="${barWidth}" height="${height}"
                                      fill="${d.cumulative >= 0 ? '#4CAF50' : '#F44336'}" opacity="0.8"/>
                                <text x="${x + barWidth/2}" y="${chartHeight + 20}"
                                      text-anchor="middle" fill="#B8C5D6" font-size="12">year-${d.year}</text>
                            `;
                        }).join('')}

                        <!-- Title -->
                        <text x="${chartWidth/2}" y="-5" text-anchor="middle" fill="#FFFFFF" font-size="14">
                            Cumulative Cash Flow (10K RMB)
                        </text>
                    </g>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // Draw IRR Sensitivity Chart
        function drawIRRChart() {
            const container = document.getElementById('irrChart');
            const width = container.offsetWidth;
            const height = 250;

            // Simulate sensitivity data
            const scenarios = [
                { name: 'Utilization -20%', irr: 32.1 },
                { name: 'Baseline', irr: 42.8 },
                { name: 'Utilization +20%', irr: 53.4 },
                { name: 'Service Fee -20%', irr: 35.2 },
                { name: 'Service Fee +20%', irr: 50.3 },
                { name: 'Cost -20%', irr: 48.9 },
                { name: 'Cost +20%', irr: 36.7 }
            ];

            const svg = `
                <svg width="${width}" height="${height}">
                    <g transform="translate(40,20)">
                        <!-- Coordinate axes -->
                        <line x1="0" y1="${height-40}" x2="${width-60}" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>
                        <line x1="0" y1="0" x2="0" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>

                        <!-- Bar chart -->
                        ${scenarios.map((s, i) => {
                            const barWidth = (width-100) / scenarios.length * 0.6;
                            const x = i * ((width-100) / scenarios.length) + 20;
                            const barHeight = (s.irr / 60) * (height-60);
                            const y = height-40-barHeight;
                            const textY = height-10-barHeight; // Moved up by 10 pixels from height-25

                            return `
                                <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}"
                                      fill="${s.name === 'Baseline' ? '#FFC72C' : '#0077C0'}" opacity="0.8"/>
                                <text x="${x + barWidth/2}" y="${y-5}" text-anchor="middle"
                                      fill="#FFFFFF" font-size="11">${s.irr}%</text>
                                <text x="${x + barWidth/2}" y="${textY}" text-anchor="middle"
                                      fill="#B8C5D6" font-size="10" transform="rotate(-45 ${x + barWidth/2} ${textY})">${s.name}</text>
                            `;
                        }).join('')}

                        <!-- Title -->
                        <text x="${(width-100)/2}" y="-5" text-anchor="middle" fill="#FFFFFF" font-size="14">
                            IRR Sensitivity Analysis (%)
                        </text>
                    </g>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // Draw ROI Analysis Chart
        function drawROIChart() {
            const container = document.getElementById('roiChart');
            const width = container.offsetWidth;
            const height = 350; // Increased height for better visibility

            // Simulate ROI data
            const years = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            const roiData = years.map(year => ({
                year: year,
                investment: year <= 4 ? -7 : 0,
                return: year > 4 ? 12.19 : 0,
                cumulativeROI: year > 4 ? ((year-4) * 12.19 - 28) / 28 * 100 : -100 + (year * 25)
            }));

            // Calculate proper scaling to fit all data
            const maxROI = Math.max(...roiData.map(d => d.cumulativeROI));
            const minROI = Math.min(...roiData.map(d => d.cumulativeROI));
            const range = maxROI - minROI;
            const scale = (height - 100) / range; // Dynamic scaling
            const zeroLineY = height - 40 - (0 - minROI) * scale;

            const svg = `
                <svg width="${width}" height="${height}">
                    <g transform="translate(60,20)">
                        <!-- Coordinate axes -->
                        <line x1="0" y1="${height-40}" x2="${width-80}" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>
                        <line x1="0" y1="0" x2="0" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>

                        <!-- Zero line -->
                        <line x1="0" y1="${zeroLineY}" x2="${width-80}" y2="${zeroLineY}"
                              stroke="#FFC72C" stroke-width="1" stroke-dasharray="5,5"/>

                        <!-- ROI line chart -->
                        <polyline points="${roiData.map(d =>
                            `${(d.year-1) * (width-100) / 9},${height-40-(d.cumulativeROI - minROI) * scale}`
                        ).join(' ')}"
                                  fill="none" stroke="#FFC72C" stroke-width="3"/>

                        <!-- Data points -->
                        ${roiData.map(d => {
                            const y = height-40-(d.cumulativeROI - minROI) * scale;
                            return `
                                <circle cx="${(d.year-1) * (width-100) / 9}"
                                        cy="${y}" r="5" fill="#FFC72C"/>
                                <text x="${(d.year-1) * (width-100) / 9}" y="${height-25}"
                                      text-anchor="middle" fill="#B8C5D6" font-size="12">year-${d.year}</text>
                            `;
                        }).join('')}

                        <!-- Title -->
                        <text x="${(width-100)/2}" y="-5" text-anchor="middle" fill="#FFFFFF" font-size="16">
                            Investment Return Rate (ROI) Trend
                        </text>

                        <!-- Y-axis labels -->
                        <text x="-10" y="5" text-anchor="end" fill="#B8C5D6" font-size="12">${Math.round(maxROI)}%</text>
                        <text x="-10" y="${zeroLineY}" text-anchor="end" fill="#FFC72C" font-size="12">0%</text>
                        <text x="-10" y="${height-40}" text-anchor="end" fill="#B8C5D6" font-size="12">${Math.round(minROI)}%</text>
                    </g>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // Load Investment Scenarios
        function loadScenario(scenario) {
            currentScenario = scenario;

            // Update button status
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Adjust parameters based on scenario
            const scenarios = {
                conservative: {
                    utilizationRate: 20,
                    serviceFee: 0.6,
                    maintenanceCost: 18,
                    totalInvestment: 32
                },
                baseline: {
                    utilizationRate: 25,
                    serviceFee: 0.8,
                    maintenanceCost: 15,
                    totalInvestment: 28
                },
                optimistic: {
                    utilizationRate: 35,
                    serviceFee: 1.0,
                    maintenanceCost: 12,
                    totalInvestment: 25
                },
                custom: {
                    // Keep current parameters
                }
            };

            const params = scenarios[scenario];
            if (params && scenario !== 'custom') {
                document.getElementById('utilizationRate').value = params.utilizationRate;
                document.getElementById('serviceFee').value = params.serviceFee;
                document.getElementById('maintenanceCost').value = params.maintenanceCost;
                document.getElementById('totalInvestment').value = params.totalInvestment;
            }

            // Recalculate
            calculateResults();
        }

        // Initialize Calculator
        function initCalculator() {
            calculateResults();
        }

        // Initialize Scenario Analysis
        function initScenarios() {
            drawScenarioChart();
        }

        // Draw Scenario Comparison Chart
        function drawScenarioChart() {
            const container = document.getElementById('scenarioChart');
            const width = container.offsetWidth;
            const height = 300;

            const scenarios = [
                { name: 'Pessimistic Scenario', irr: 32.1, npv: 8.2, payback: 5.8 },
                { name: 'Baseline Scenario', irr: 42.8, npv: 12.4, payback: 4.5 },
                { name: 'Optimistic Scenario', irr: 58.3, npv: 21.8, payback: 3.2 }
            ];

            const svg = `
                <svg width="${width}" height="${height}">
                    <g transform="translate(60,20)">
                        <!-- Coordinate axes -->
                        <line x1="0" y1="${height-40}" x2="${width-80}" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>
                        <line x1="0" y1="0" x2="0" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>

                        <!-- IRR bar chart -->
                        ${scenarios.map((s, i) => {
                            const barWidth = 80;
                            const x = i * 120;
                            const height = (s.irr / 70) * (height-60);
                            const y = height-40-height;

                            return `
                                <rect x="${x}" y="${y}" width="${barWidth}" height="${height}"
                                      fill="#0077C0" opacity="0.8"/>
                                <text x="${x + barWidth/2}" y="${y-5}" text-anchor="middle"
                                      fill="#FFFFFF" font-size="14">${s.irr}%</text>
                                <text x="${x + barWidth/2}" y="${height-25}" text-anchor="middle"
                                      fill="#B8C5D6" font-size="12">${s.name}</text>
                                <text x="${x + barWidth/2}" y="${height-10}" text-anchor="middle"
                                      fill="#FFC72C" font-size="11">Payback ${s.payback} Years</text>
                            `;
                        }).join('')}

                        <!-- Title -->
                        <text x="${(width-100)/2}" y="-5" text-anchor="middle" fill="#FFFFFF" font-size="16">
                            Investment Scenario Comparative Analysis
                        </text>
                    </g>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // Initialize Risk Assessment
        function initRiskAssessment() {
            drawRiskSpiderChart();
        }

        // Draw Risk Assessment Spider Chart
        function drawRiskSpiderChart() {
            const svg = document.getElementById('riskSpiderChart');
            const width = svg.clientWidth;
            const height = 250;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - 40;

            const risks = [
                { name: 'Technical Risk', value: 35 },
                { name: 'Market Risk', value: 25 },
                { name: 'Policy Risk', value: 40 },
                { name: 'Financial Risk', value: 20 },
                { name: 'Operational Risk', value: 30 },
                { name: 'Environmental Risk', value: 15 }
            ];

            const angleStep = (Math.PI * 2) / risks.length;

            let paths = [];
            let labels = [];

            risks.forEach((risk, i) => {
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;

                // Grid lines
                paths.push(`<line x1="${centerX}" y1="${centerY}" x2="${x}" y2="${y}"
                                stroke="#B8C5D6" stroke-width="1" opacity="0.3"/>`);

                // Risk value points
                const value = risk.value / 100;
                const vx = centerX + Math.cos(angle) * radius * value;
                const vy = centerY + Math.sin(angle) * radius * value;

                labels.push(`
                    <text x="${x + 20 * Math.cos(angle)}" y="${y + 20 * Math.sin(angle)}"
                          text-anchor="middle" fill="#B8C5D6" font-size="12">${risk.name}</text>
                    <circle cx="${vx}" cy="${vy}" r="4" fill="#FFC72C"/>
                `);
            });

            svg.innerHTML = `
                ${paths.join('')}
                <!-- Risk area -->
                <polygon points="${risks.map((risk, i) => {
                    const angle = i * angleStep - Math.PI / 2;
                    const value = risk.value / 100;
                    const x = centerX + Math.cos(angle) * radius * value;
                    const y = centerY + Math.sin(angle) * radius * value;
                    return `${x},${y}`;
                }).join(' ')}" fill="#0077C0" opacity="0.3" stroke="#0077C0" stroke-width="2"/>
                ${labels.join('')}
            `;
        }

        // Initialize Data Visualization
        function initVisualization() {
            drawMarketTrendChart();
            drawEVGrowthChart();
            drawTechRoadmapChart();
        }

        // Draw Market Trend Chart
        function drawMarketTrendChart() {
            const container = document.getElementById('marketTrendChart');
            // Simulate market trend data visualization
            container.innerHTML = `
                <div style="color: #B8C5D6; text-align: center; padding: 40px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 20px;">Charging Pile Market Growth Trend</h4>
                    <p>2023: 300 Billion RMB → 2028: 1250 Billion RMB</p>
                    <p style="color: #FFC72C; font-size: 24px; font-weight: bold; margin: 20px 0;">Annual Compound Growth Rate 35%</p>
                    <div style="display: flex; justify-content: space-around; margin-top: 30px;">
                        <div>
                            <div style="color: #4CAF50; font-size: 18px;">📈</div>
                            <div>Policy Driven</div>
                        </div>
                        <div>
                            <div style="color: #0077C0; font-size: 18px;">🚗</div>
                            <div>EV Adoption</div>
                        </div>
                        <div>
                            <div style="color: #FFC72C; font-size: 18px;">⚡</div>
                            <div>Technology Upgrade</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Draw Electric Vehicle Growth Chart
        function drawEVGrowthChart() {
            const container = document.getElementById('evGrowthChart');
            container.innerHTML = `
                <div style="color: #B8C5D6; text-align: center; padding: 40px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 20px;">Electric Vehicle Ownership Forecast</h4>
                    <div style="display: flex; justify-content: space-around; align-items: center; height: 150px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #B8C5D6;">2023</div>
                            <div style="font-size: 18px; color: #4CAF50; margin: 10px 0;">9.5 Million</div>
                            <div>Penetration Rate 35%</div>
                        </div>
                        <div style="font-size: 30px; color: #FFC72C;">→</div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #FFFFFF;">2028</div>
                            <div style="font-size: 18px; color: #0077C0; margin: 10px 0;">70 Million</div>
                            <div>Penetration Rate 60%</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(29, 66, 138, 0.3); border-radius: 10px;">
                        <div style="color: #FFC72C;">💡 Charging demand will grow 7.4x simultaneously</div>
                    </div>
                </div>
            `;
        }

        // Draw Technology Roadmap Chart
        function drawTechRoadmapChart() {
            const container = document.getElementById('techRoadmapChart');
            container.innerHTML = `
                <div style="color: #B8C5D6; padding: 20px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 20px;">Liquid-Cooled Ultra-Fast Charging Technology Evolution Roadmap</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="text-align: center; flex: 1;">
                            <div style="background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; border-radius: 10px; padding: 15px;">
                                <div style="font-size: 16px; font-weight: bold; color: #4CAF50;">Current</div>
                                <div style="margin: 10px 0;">600kW</div>
                                <div style="font-size: 12px;">Liquid-Cooled Ultra-Fast Charging</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; color: #B8C5D6; margin: 0 20px;">→</div>
                        <div style="text-align: center; flex: 1;">
                            <div style="background: rgba(0, 119, 192, 0.2); border: 1px solid #0077C0; border-radius: 10px; padding: 15px;">
                                <div style="font-size: 16px; font-weight: bold; color: #0077C0;">2025</div>
                                <div style="margin: 10px 0;">800kW</div>
                                <div style="font-size: 12px;">Next Generation Ultra-Fast Charging</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; color: #B8C5D6; margin: 0 20px;">→</div>
                        <div style="text-align: center; flex: 1;">
                            <div style="background: rgba(255, 199, 44, 0.2); border: 1px solid #FFC72C; border-radius: 10px; padding: 15px;">
                                <div style="font-size: 16px; font-weight: bold; color: #FFC72C;">2026</div>
                                <div style="margin: 10px 0;">1000kW</div>
                                <div style="font-size: 12px;">Megawatt-Level Charging</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(29, 66, 138, 0.3); border-radius: 10px; text-align: center;">
                        <div style="color: #FFC72C;">🚀 Continuous technology iteration, maintaining industry leadership position</div>
                    </div>
                </div>
            `;
        }

        // Export Functions
        function exportChart() {
            alert('Chart export function: Supports PNG, PDF, Excel format export');
        }

        function exportRiskReport() {
            alert('Risk assessment report export: Contains complete risk analysis and response recommendations');
        }

        // Initialize after page load completes
        document.addEventListener('DOMContentLoaded', function() {
            initCalculator();

            // Monitor parameter changes, update calculations in real-time
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (document.getElementById('calculator').classList.contains('active')) {
                        calculateResults();
                    }
                });
            });

            // Monitor risk slider changes
            const riskSliders = document.querySelectorAll('.risk-slider');
            riskSliders.forEach(slider => {
                slider.addEventListener('input', function() {
                    updateRiskLevel(this);
                    drawRiskSpiderChart();
                });
            });
        });

        // Update risk level display
        function updateRiskLevel(slider) {
            const value = parseInt(slider.value);
            const riskElement = slider.parentElement.querySelector('.risk-level');

            let level, className;
            if (value < 30) {
                level = 'Low';
                className = 'risk-low';
            } else if (value < 60) {
                level = 'Medium';
                className = 'risk-medium';
            } else {
                level = 'High';
                className = 'risk-high';
            }

            riskElement.textContent = level;
            riskElement.className = 'risk-level ' + className;
        }
    </script>
</body>
</html>
